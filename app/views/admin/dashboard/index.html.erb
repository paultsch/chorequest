<div class="space-y-8">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-4xl font-bold text-gray-800 mb-2">Welcome back, <%= current_parent.name %>! üëã</h1>
    <p class="text-gray-600">Here's what's happening with your family today</p>
  </div>

  <!-- Quick Stats Row -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="card bg-gradient-to-br from-blue-50 to-blue-100 border-l-4 border-blue-500">
      <div class="text-blue-600 text-3xl mb-2">üë∂</div>
      <p class="text-gray-600 text-sm">Total Children</p>
      <p class="text-3xl font-bold text-gray-800"><%= @children.count %></p>
    </div>
    
    <div class="card bg-gradient-to-br from-green-50 to-green-100 border-l-4 border-green-500">
      <div class="text-green-600 text-3xl mb-2">‚è≥</div>
      <p class="text-gray-600 text-sm">Pending Approval</p>
      <p class="text-3xl font-bold text-gray-800"><%= @pending_attempts.count %></p>
    </div>
    
    <div class="card bg-gradient-to-br from-orange-50 to-orange-100 border-l-4 border-orange-500">
      <div class="text-orange-600 text-3xl mb-2">üí∞</div>
      <p class="text-gray-600 text-sm">Total Tokens</p>
      <p class="text-3xl font-bold text-gray-800"><%= @children.sum { |c| c.token_balance } %></p>
    </div>
  </div>

  <!-- Section 1: Approval Queue -->
  <div class="card">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
        <span class="text-2xl">‚è≥</span> Chores Awaiting Approval
      </h2>
      <span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm font-semibold"><%= @pending_attempts.count %> pending</span>
    </div>

    <% if @pending_attempts.any? %>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b-2 border-gray-200">
              <th class="text-left px-4 py-2 font-semibold">Photo</th>
              <th class="text-left px-4 py-2 font-semibold">Child</th>
              <th class="text-left px-4 py-2 font-semibold">Chore</th>
              <th class="text-left px-4 py-2 font-semibold">AI Verdict</th>
              <th class="text-left px-4 py-2 font-semibold">Scheduled</th>
              <th class="text-left px-4 py-2 font-semibold">Submitted</th>
              <th class="text-right px-4 py-2 font-semibold">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @pending_attempts.each do |attempt| %>
              <%
                previous_attempts = attempt.chore_assignment.chore_attempts
                                      .reject { |a| a.id == attempt.id }
                                      .sort_by(&:created_at).reverse
              %>
              <tr class="border-b hover:bg-gray-50" id="attempt_<%= attempt.id %>">
                <td class="px-4 py-3">
                  <% if attempt.photo.attached? %>
                    <%= image_tag attempt.photo, class: 'h-16 w-16 object-cover rounded-lg border', title: 'Click to enlarge', style: 'cursor:pointer', onclick: "window.open(this.src,'_blank')" %>
                  <% else %>
                    <span class="text-gray-400 text-xs">No photo</span>
                  <% end %>
                </td>
                <td class="px-4 py-3 font-medium text-gray-800"><%= attempt.child.name %></td>
                <td class="px-4 py-3 text-gray-700">
                  <%= attempt.chore.name %>
                  <% if previous_attempts.any? %>
                    <p class="mt-1">
                      <span class="text-xs text-orange-600 font-medium">
                        <%= previous_attempts.count %> previous <%= previous_attempts.count == 1 ? 'attempt' : 'attempts' %>
                      </span>
                    </p>
                  <% end %>
                </td>
                <td class="px-4 py-3 align-top">
                  <% if attempt.ai_verdict == 'APPROVED' %>
                    <span class="inline-block bg-green-100 text-green-700 text-xs font-semibold px-2 py-1 rounded">Approved</span>
                    <% if attempt.ai_message.present? %>
                      <p class="text-xs text-green-700 mt-1 italic"><%= attempt.ai_message %></p>
                    <% end %>
                  <% elsif attempt.ai_verdict == 'REJECTED' %>
                    <span class="inline-block bg-red-100 text-red-700 text-xs font-semibold px-2 py-1 rounded">Rejected</span>
                    <% if attempt.ai_message.present? %>
                      <p class="text-xs text-red-700 mt-1 italic"><%= attempt.ai_message %></p>
                    <% end %>
                  <% elsif attempt.ai_verdict == 'NEEDS_REVIEW' %>
                    <span class="inline-block bg-yellow-100 text-yellow-700 text-xs font-semibold px-2 py-1 rounded">Unclear</span>
                    <% if attempt.ai_message.present? %>
                      <p class="text-xs text-yellow-700 mt-1 italic"><%= attempt.ai_message %></p>
                    <% end %>
                  <% else %>
                    <span class="text-xs text-gray-400">Not analyzed</span>
                  <% end %>
                </td>
                <td class="px-4 py-3 text-gray-600 text-sm"><%= attempt.chore_assignment.scheduled_on.present? ? l(attempt.chore_assignment.scheduled_on, format: :long) : '‚Äî' %></td>
                <td class="px-4 py-3 text-gray-600 text-sm"><%= l(attempt.created_at, format: :long) %></td>
                <td class="px-4 py-3 text-right align-top">
                  <div class="flex flex-col items-end gap-2">
                    <%= button_to approve_chore_attempt_path(attempt), method: :post, class: 'px-3 py-1 rounded-lg bg-green-500 hover:bg-green-600 text-white text-sm font-medium' do %>Approve<% end %>
                    <button type="button"
                            class="px-3 py-1 rounded-lg bg-red-500 hover:bg-red-600 text-white text-sm font-medium"
                            onclick="document.getElementById('reject_form_<%= attempt.id %>').classList.toggle('hidden')">
                      Reject
                    </button>
                  </div>
                  <!-- Inline reject form -->
                  <div id="reject_form_<%= attempt.id %>" class="hidden mt-2 p-3 bg-red-50 border border-red-200 rounded-lg text-left">
                    <%= form_with url: reject_chore_attempt_path(attempt), method: :post do |f| %>
                      <label class="block text-xs font-medium text-red-700 mb-1">Reason (optional)</label>
                      <textarea name="parent_note" rows="2" class="w-full text-sm border border-red-200 rounded p-1 mb-2 resize-none" placeholder="e.g. The dishes still have food on them"></textarea>
                      <div class="flex gap-2">
                        <%= f.submit 'Confirm Reject', class: 'px-3 py-1 bg-red-600 text-white text-xs rounded font-medium' %>
                        <button type="button" class="px-3 py-1 text-xs text-gray-600 hover:underline"
                                onclick="document.getElementById('reject_form_<%= attempt.id %>').classList.add('hidden')">Cancel</button>
                      </div>
                    <% end %>
                  </div>
                </td>
              </tr>
              <% if previous_attempts.any? %>
                <tr class="bg-orange-50 border-b">
                  <td colspan="7" class="px-4 py-2">
                    <details class="text-sm">
                      <summary class="cursor-pointer text-orange-700 font-medium text-xs select-none">
                        View <%= previous_attempts.count %> previous <%= previous_attempts.count == 1 ? 'attempt' : 'attempts' %>
                      </summary>
                      <div class="mt-2 space-y-2 pl-2 border-l-2 border-orange-200">
                        <% previous_attempts.each do |prev| %>
                          <div class="flex items-start gap-3 py-1">
                            <% if prev.photo.attached? %>
                              <%= image_tag prev.photo, class: 'h-12 w-12 object-cover rounded border flex-shrink-0', style: 'cursor:pointer', onclick: "window.open(this.src,'_blank')" %>
                            <% else %>
                              <div class="h-12 w-12 bg-gray-100 rounded border flex items-center justify-center flex-shrink-0">
                                <span class="text-gray-400 text-xs">none</span>
                              </div>
                            <% end %>
                            <div>
                              <p class="text-xs text-gray-500"><%= l(prev.created_at, format: :long) %></p>
                              <% if prev.status_rejected? %>
                                <% if prev.ai_verdict == 'REJECTED' %>
                                  <p class="text-xs text-red-700">
                                    <span class="font-medium">AI rejected:</span>
                                    <%= prev.ai_message.present? ? prev.ai_message : 'No reason given' %>
                                  </p>
                                <% elsif prev.parent_note.present? %>
                                  <p class="text-xs text-red-700">
                                    <span class="font-medium">Parent rejected:</span>
                                    <%= prev.parent_note %>
                                  </p>
                                <% else %>
                                  <p class="text-xs text-red-600 italic">Rejected ‚Äî no reason given</p>
                                <% end %>
                              <% else %>
                                <span class="text-xs text-gray-500 capitalize"><%= prev.status %></span>
                              <% end %>
                            </div>
                          </div>
                        <% end %>
                      </div>
                    </details>
                  </td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-gray-600 text-center py-8">üéâ All chores approved! Great job!</p>
    <% end %>
  </div>

  <!-- Action Buttons -->
  <div class="flex gap-4 justify-center">
    <%= link_to '+ New Chore Assignment', new_chore_assignment_path, class: "px-6 py-3 rounded-lg bg-blue-500 text-white hover:bg-blue-600 font-semibold transition-all" %>
    <%= link_to '+ New Chore', new_chore_path, class: "px-6 py-3 rounded-lg bg-purple-500 text-white hover:bg-purple-600 font-semibold transition-all" %>
  </div>
</div>
