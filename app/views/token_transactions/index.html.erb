<% if notice %>
  <div class="p-3 bg-green-50 border-l-4 border-green-500 text-green-700 rounded mb-4"><%= notice %></div>
<% end %>

<div class="flex items-center justify-between mb-4">
  <h1 class="text-2xl font-bold">Token transactions</h1>
  <div>
    <%= link_to 'New transaction', new_token_transaction_path, class: 'btn btn-primary' if current_parent %>
  </div>
</div>

<table class="min-w-full bg-white border">
  <thead>
    <tr>
      <th class="px-4 py-2 text-left">Date
        <%= link_to '↕', token_transactions_path(sort: 'date', direction: (params[:sort] == 'date' && params[:direction] == 'desc') ? 'asc' : 'desc'), class: 'ml-2 text-sm text-gray-500' %>
      </th>
      <th class="px-4 py-2 text-left">Child
        <%= link_to '↕', token_transactions_path(sort: 'child', direction: (params[:sort] == 'child' && params[:direction] == 'desc') ? 'asc' : 'desc'), class: 'ml-2 text-sm text-gray-500' %>
      </th>
      <th class="px-4 py-2 text-left">Amount
        <%= link_to '↕', token_transactions_path(sort: 'amount', direction: (params[:sort] == 'amount' && params[:direction] == 'desc') ? 'asc' : 'desc'), class: 'ml-2 text-sm text-gray-500' %>
      </th>
      <th class="px-4 py-2 text-left">Description
        <%= link_to '↕', token_transactions_path(sort: 'description', direction: (params[:sort] == 'description' && params[:direction] == 'desc') ? 'asc' : 'desc'), class: 'ml-2 text-sm text-gray-500' %>
      </th>
      <th class="px-4 py-2 text-left">Balance after</th>
      <th class="px-4 py-2 text-left">Actions</th>
    </tr>
  </thead>
  <tbody>
    <% @token_transactions.each do |tx| %>
      <tr class="border-t">
        <td class="px-4 py-3"><%= tx.created_at.strftime('%F %R') %></td>
        <td class="px-4 py-3"><%= tx.child&.name %></td>
        <td class="px-4 py-3"><%= tx.amount %></td>
        <td class="px-4 py-3 text-sm text-gray-600"><%= tx.description %></td>
        <td class="px-4 py-3"><%= @balance_after[tx.id] || tx.child&.token_balance %></td>
        <td class="px-4 py-3">
          <% if current_parent %>
            <div class="flex items-center gap-2">
              <%= link_to 'Edit', edit_token_transaction_path(tx), class: 'btn btn-sm' %>
              <%= button_to 'Delete', token_transaction_path(tx), method: :delete, data: { confirm: 'Delete this transaction?' }, class: 'btn btn-danger btn-sm' %>
            </div>
          <% else %>
            —
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<div class="mt-4 flex items-center justify-between">
  <div class="text-sm text-gray-600">Showing page <%= @page %> — <%= @total_count %> total</div>
  <div class="flex items-center gap-2">
    <% if @page > 1 %>
      <%= link_to 'Previous', token_transactions_path(page: @page - 1, sort: params[:sort], direction: params[:direction]), class: 'btn' %>
    <% end %>
    <% if (@page * @per_page) < @total_count %>
      <%= link_to 'Next', token_transactions_path(page: @page + 1, sort: params[:sort], direction: params[:direction]), class: 'btn btn-primary' %>
    <% end %>
  </div>
</div>
