<div class="max-w-4xl mx-auto space-y-6">
  <% if notice %>
    <div class="p-4 bg-green-50 border-l-4 border-green-500 text-green-700 rounded-lg">
      <%= notice %>
    </div>
  <% end %>

  <section class="bg-white rounded-2xl shadow p-6 md:p-8">
    <div class="flex items-center justify-between gap-6">
      <div>
        <h1 class="text-3xl font-extrabold text-gray-900"><%= @child.name %></h1>
        <p class="text-sm text-gray-600">Age: <%= @child.age %></p>
      </div>
      <div class="text-right">
        <div class="text-sm text-gray-600">Tokens</div>
        <div class="text-2xl font-bold text-gray-900"><%= @child.token_balance %></div>
      </div>
    </div>

    <div class="mt-6">
      <% if current_parent %>
        <div class="mb-4 p-4 bg-yellow-50 border border-yellow-100 rounded">
          <div class="flex items-center justify-between">
            <div>
              <strong class="block text-sm text-yellow-800">Public chore link</strong>
              <% if @child.public_token.present? %>
                <div class="text-sm mt-1">
                  <% full = "#{request.base_url}#{@child.public_link}" %>
                  <%= link_to full, full, target: :_blank, rel: 'noopener', class: 'text-indigo-600' %>
                </div>
              <% else %>
                <div class="text-sm text-gray-600">No public link yet. Generate one below.</div>
              <% end %>
            </div>
            <div>
              <%= button_to regenerate_public_link_child_path(@child), method: :post, class: 'btn btn-secondary' do %>
                Generate / Regenerate Link
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <h2 class="text-lg font-semibold text-gray-800 mb-4">Today's chores â€” <span class="text-sm text-gray-600"><%= l(Date.current, format: :long) %></span></h2>

      <% todays = @child.chore_assignments.where(scheduled_on: Date.current).order(:id) %>
      <% if todays.any? %>
        <div class="mb-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <% todays.each do |assignment| %>
              <div class="p-4 bg-gray-50 rounded-lg border border-gray-100">
                <div class="flex items-start justify-between gap-4">
                  <div>
                    <div class="font-semibold text-gray-900"><%= assignment.chore&.name || 'Chore' %></div>
                    <% if assignment.chore&.definition_of_done.present? %>
                      <div class="text-sm text-gray-600"><%= assignment.chore.definition_of_done %></div>
                    <% end %>
                    <div class="text-xs text-gray-500 mt-1">Scheduled: <%= l(assignment.scheduled_on, format: :long) %></div>
                  </div>
                    <div class="flex items-center gap-2">
                      <% if assignment.completed %>
                        <div class="flex items-center gap-2">
                          <span class="px-3 py-1 rounded-full bg-green-100 text-green-700 text-sm">Completed</span>
                          <% if assignment.approved.nil? %>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Awaiting approval</span>
                          <% elsif assignment.approved == true %>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-50 text-green-800">Approved</span>
                          <% end %>
                        </div>
                      <% else %>
                        <%= button_to mark_complete_chore_assignment_path(assignment), method: :post, class: "btn btn-primary", form: { data: { turbo: false } } do %>
                          Mark Done
                        <% end %>
                      <% end %>
                    </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% else %>
        <div class="mb-4 text-sm text-gray-600">No chores scheduled for today.</div>
      <% end %>

      <h2 class="text-lg font-semibold text-gray-800 mb-4">Upcoming chores</h2>

      <% cutoff = Date.current + 90.days %>
      <% upcoming = @child.chore_assignments.where('scheduled_on > ? AND scheduled_on <= ?', Date.current, cutoff).order(:scheduled_on) %>
      <% upcoming_grouped = upcoming.group_by(&:scheduled_on) %>
      <% if upcoming_grouped.any? %>
        <% upcoming_grouped.each do |date, assignments| %>
          <div class="mb-4">
            <h3 class="text-sm font-medium text-gray-700 mb-2"><%= l(date, format: :long) %></h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <% assignments.each do |assignment| %>
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-100">
                  <div class="flex items-start justify-between gap-4">
                    <div>
                      <div class="font-semibold text-gray-900"><%= assignment.chore&.name || 'Chore' %></div>
                      <% if assignment.chore&.definition_of_done.present? %>
                        <div class="text-sm text-gray-600"><%= assignment.chore.definition_of_done %></div>
                      <% end %>
                      <div class="text-xs text-gray-500 mt-1">Scheduled: <%= l(assignment.scheduled_on, format: :long) %></div>
                    </div>
                    <div class="flex items-center gap-2">
                      <% if assignment.completed %>
                        <div class="flex items-center gap-2">
                          <span class="px-3 py-1 rounded-full bg-green-100 text-green-700 text-sm">Completed</span>
                          <% if assignment.approved.nil? %>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Awaiting approval</span>
                          <% elsif assignment.approved == false %>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Rejected</span>
                          <% end %>
                        </div>
                      <% else %>
                        <span class="px-3 py-1 rounded-full bg-gray-100 text-gray-700 text-sm">Upcoming</span>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="mb-4 text-sm text-gray-600">No upcoming chores scheduled.</div>
      <% end %>
    </div>

    <% if current_parent %>
      <div class="mt-6 flex gap-3">
        <%= link_to 'Edit Profile', edit_child_path(@child), class: 'btn btn-secondary' %>
        <%= link_to 'Back to Children', children_path, class: 'btn' %>
        <%= button_to 'Delete Child', @child, method: :delete, data: { confirm: 'Delete this child?' }, class: 'btn btn-danger' %>
        <%# Play games button: enabled only when all today's chores are completed %>
        <% todays_incomplete = @child.chore_assignments.where(scheduled_on: Date.current).where(completed: [false, nil]).exists? %>
        <% btn_disabled = todays_incomplete %>
        <%= button_to play_child_path(@child), method: :post, class: 'btn btn-primary ml-2', disabled: btn_disabled do %>
          Play games
        <% end %>
      </div>
    <% else %>
      <div class="mt-6">
        <%= link_to 'Back to Public View', root_path, class: 'text-sm text-gray-500' %>
      </div>
    <% end %>
  </section>
</div>
