<%# Assignment Scheduler â€” drag chores onto calendar days to assign them.
    Desktop: drag-and-drop. Mobile: tap a chore to select it, then tap a day. %>

<div class="mb-6 flex items-center justify-between">
  <h1 class="text-2xl font-extrabold text-gray-900 tracking-tight">Assignment Scheduler</h1>
  <%= link_to "Manage Chores", chores_path, class: "text-sm text-blue-600 hover:underline font-medium" %>
</div>

<div data-controller="scheduler"
     data-scheduler-child-id-value="<%= @selected_child&.id.to_i %>">

  <%# â”€â”€ Child selector pills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ %>
  <% if @children.any? %>
    <div class="flex gap-2 overflow-x-auto pb-2 mb-5 -mx-1 px-1">
      <% @children.each do |child| %>
        <% pill_bg = @selected_child == child ? 'bg-blue-600 text-white shadow-sm' : 'bg-white text-gray-700 border border-gray-200 hover:border-blue-300 hover:text-blue-600' %>
        <%= link_to chore_assignments_path(child_id: child.id, view: @view,
                      year: @year, month: @month,
                      week_start: @week_start&.iso8601),
              class: "whitespace-nowrap px-4 py-2 rounded-full font-semibold text-sm transition-all #{pill_bg}" do %>
          <%= child.name %>
        <% end %>
      <% end %>
    </div>
  <% else %>
    <div class="mb-5 p-4 bg-amber-50 border border-amber-200 rounded-xl text-amber-800 text-sm">
      No children yet. <%= link_to "Add a child", new_child_path, class: "font-semibold underline" %> to start scheduling.
    </div>
  <% end %>

  <%# â”€â”€ Two-column layout: sidebar (desktop) / bottom strip (mobile) â”€â”€â”€â”€â”€ %>
  <div class="flex flex-col md:flex-row gap-4">

    <%# Chore strip â€” horizontal scroll on mobile, vertical list on desktop %>
    <div class="order-2 md:order-1 md:w-52 md:flex-shrink-0">
      <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 hidden md:block">
        Chores
      </p>
      <p class="text-xs text-gray-400 mb-2 md:hidden text-center">
        Tap a chore, then tap a day above
      </p>
      <% if @chores.any? %>
        <div class="flex md:flex-col gap-2 overflow-x-auto md:overflow-visible pb-2 md:pb-0">
          <% @chores.each do |chore| %>
            <div draggable="true"
                 data-scheduler-target="chore"
                 data-chore-id="<%= chore.id %>"
                 data-chore-name="<%= chore.name %>"
                 data-chore-tokens="<%= chore.token_amount %>"
                 data-chore-require-photo="false"
                 data-action="dragstart->scheduler#dragStart
                              click->scheduler#choreSelected
                              touchend->scheduler#choreSelected"
                 class="flex-shrink-0 md:flex-shrink bg-white border-2 border-transparent
                        rounded-xl p-3 cursor-grab active:cursor-grabbing shadow-sm
                        hover:shadow-md hover:border-blue-200 transition-all
                        min-w-[140px] md:min-w-0 select-none">
              <div class="font-semibold text-gray-900 text-sm leading-tight truncate">
                <%= chore.name %>
              </div>
              <div class="text-xs text-blue-600 mt-1 font-medium">
                ðŸª™ <%= chore.token_amount %> token<%= chore.token_amount == 1 ? '' : 's' %>
              </div>
              <%# Photo toggle â€” client-side only; state is sent in the POST when a chip is created %>
              <button type="button"
                      class="mt-1.5 flex items-center gap-1 text-xs text-red-400 transition-colors"
                      data-action="click->scheduler#toggleChorePhoto"
                      title="Toggle photo requirement for new assignments">
                <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 15.2a3.2 3.2 0 100-6.4 3.2 3.2 0 000 6.4z"/>
                  <path fill-rule="evenodd" d="M9 2L7.17 4H4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2h-3.17L15 2H9zm3 15a5 5 0 110-10 5 5 0 010 10z" clip-rule="evenodd"/>
                </svg>
                <span class="photo-label">photo off</span>
              </button>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-sm text-gray-400 text-center md:text-left">
          <%= link_to "Add chores", new_chore_path, class: "text-blue-600 hover:underline" %> to schedule them.
        </p>
      <% end %>
    </div>

    <%# â”€â”€ Calendar panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ %>
    <div class="order-1 md:order-2 flex-1 min-w-0">

      <%# View toggle + prev/next navigation %>
      <div class="flex items-center justify-between mb-3 gap-2 flex-wrap">

        <%# Month / Week toggle %>
        <div class="flex items-center bg-gray-100 rounded-lg p-1 gap-1">
          <%= link_to "Month",
                chore_assignments_path(child_id: @selected_child&.id, view: 'month',
                  year: @year, month: @month),
                class: "px-3 py-1 rounded-md text-sm font-semibold transition-all
                        #{@view == 'month' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'}",
                data: { turbo_frame: "scheduler-calendar" } %>
          <%= link_to "Week",
                chore_assignments_path(child_id: @selected_child&.id, view: 'week',
                  week_start: (@week_start || Date.current.beginning_of_week(:sunday)).iso8601),
                class: "px-3 py-1 rounded-md text-sm font-semibold transition-all
                        #{@view == 'week' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'}",
                data: { turbo_frame: "scheduler-calendar" } %>
        </div>

        <%# Prev / period label / Next %>
        <div class="flex items-center gap-1">
          <% if @view == 'month' %>
            <%= link_to "â€¹", prev_month_path(@year, @month, @selected_child&.id),
                  class: "w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-600 font-bold transition",
                  data: { turbo_frame: "scheduler-calendar" } %>
            <span class="text-sm font-semibold text-gray-800 w-32 text-center select-none">
              <%= Date::MONTHNAMES[@month] %> <%= @year %>
            </span>
            <%= link_to "â€º", next_month_path(@year, @month, @selected_child&.id),
                  class: "w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-600 font-bold transition",
                  data: { turbo_frame: "scheduler-calendar" } %>
          <% else %>
            <%= link_to "â€¹", prev_week_path(@week_start, @selected_child&.id),
                  class: "w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-600 font-bold transition",
                  data: { turbo_frame: "scheduler-calendar" } %>
            <span class="text-sm font-semibold text-gray-800 w-40 text-center select-none">
              <%= @period_start.strftime('%b %-d') %> â€“ <%= @period_end.strftime('%b %-d, %Y') %>
            </span>
            <%= link_to "â€º", next_week_path(@week_start, @selected_child&.id),
                  class: "w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-600 font-bold transition",
                  data: { turbo_frame: "scheduler-calendar" } %>
          <% end %>
        </div>
      </div>

      <%# Calendar frame â€” reloads when child/view/period changes %>
      <%= turbo_frame_tag "scheduler-calendar" do %>
        <% if @view == 'month' %>
          <%= render 'calendar_month',
                assignments_by_date: @assignments_by_date,
                year: @year, month: @month,
                selected_child: @selected_child %>
        <% else %>
          <%= render 'calendar_week',
                assignments_by_date: @assignments_by_date,
                week_start: @week_start,
                selected_child: @selected_child %>
        <% end %>
      <% end %>
    </div>

  </div>
</div>
